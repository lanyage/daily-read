# 一致性哈希

## 普通的哈希算法是怎么样的？
比如说key%N,N是节点数量,当有新的机器进入集群,或者有机器退出。数据不会被影射到集群,导致key影射失效,导致数据丢失。

## 解决办法有吗？胸得？
有啊,使用一致性哈希啦。一致性哈希是分布式常用的算法,用于负载均衡和分布式缓存。

#### 环形hash空间
* 一致性哈希算法将value映射到0-2^32的空间里,形成一个环形闭环.
* 然后将机器节点也通过将其hash或者别名映射到环上.
* 最后按照顺时针方向,将object存储到离自己最近的机器中。

#### 新节点的加入
当一个新节点的加入,会导致原先可能属于下游的部分数据迁移到新节点上来,这样的数据迁移是最小的。
#### 节点出现故障
如果某个节点出现了故障,会导致原先属于自己的数据被迁移到其下游节点。

#### 如何保证平衡性
通过对原先节点进行复制,生成新的虚拟节点,一个真实节点可以对应多个虚拟节点。

虚拟节点的hash可以用这样来计算hash(127.0.0.1#1),表示第一个虚拟节点。

